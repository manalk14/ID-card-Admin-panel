<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customer Messages | Admin</title>
  <link rel="stylesheet" href="fontawesome-free-7.1.0-web/fontawesome-free-7.1.0-web/css/all.min.css"/>
  <link rel="stylesheet" href="sidebar.css">
  <style>
    :root {
      --primary:#696cff; --primary-dark:#5f61e6; --secondary:#8592a3;
      --success:#71dd37; --warning:#ffab00; --danger:#ff3e1d;
      --info:#03c3ec; --dark:#233446; --light:#f5f5f9;
      --border-color:#d9dee3; --card-bg:#fff; --body-bg:#f5f5f9;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background-color: var(--body-bg);
      font-family: 'Segoe UI', system-ui, sans-serif;
      color: #697a8d;
      height: 100vh;
      overflow: hidden;
      display: flex;
    }

    /* Main layout */
    .container {
      flex: 1;
      padding: 1rem;
      margin-left: 250px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    @media(max-width: 992px) {
      .container {
        margin-left: 0;
        padding: 0.75rem;
      }
    }

    /* Mobile Toggle */
    .menu-toggle {
      display: none;
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 2000;
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 8px 12px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    
    @media(max-width: 992px) {
      .menu-toggle { display: block; }
    }

    /* Overlay mobile */
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,.4);
      backdrop-filter: blur(2px);
      z-index: 1500;
    }
    
    .overlay.active { display: block; }

    /* Header */
    .main-header {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .header-left h1 {
      font-size: 1.3rem;
      color: var(--dark);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .header-right {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }

    /* Search box */
    .search-box {
      position: relative;
      width: 200px;
    }
    
    .search-input {
      width: 100%;
      padding: 0.5rem 0.75rem 0.5rem 2.5rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.85rem;
      color: var(--dark);
      background: white;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .search-icon {
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--secondary);
    }

    /* Buttons */
    .btn {
      padding: 0.5rem 0.75rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .btn-secondary {
      background: var(--secondary);
      color: white;
    }
    
    .btn-outline {
      border: 1px solid var(--primary);
      color: var(--primary);
      background: transparent;
    }
    
    .btn-outline:hover {
      background: rgba(105,108,255,0.05);
    }
    
    .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }

    /* Main content area - No scroll */
    .content-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      background: white;
      border-radius: 8px 8px 0 0;
    }
    
    .tab {
      padding: 0.75rem 1.5rem;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--secondary);
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    
    .tab:hover {
      color: var(--primary);
    }
    
    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    /* Messages grid - No scroll */
    .messages-grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      height: 100%;
      min-height: 0;
    }
    
    @media (max-width: 768px) {
      .messages-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Message list */
    .message-list {
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .message-list-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .message-list-body {
      flex: 1;
      overflow-y: auto;
      padding: 0;
    }
    
    /* Message item */
    .message-item {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .message-item:hover {
      background: rgba(105,108,255,0.05);
    }
    
    .message-item.active {
      background: rgba(105,108,255,0.1);
      border-left: 3px solid var(--primary);
    }
    
    .message-item.unread {
      background: rgba(255,62,29,0.05);
    }
    
    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }
    
    .message-sender {
      font-weight: 600;
      color: var(--dark);
      font-size: 0.9rem;
    }
    
    .message-time {
      font-size: 0.75rem;
      color: var(--secondary);
    }
    
    .message-preview {
      font-size: 0.85rem;
      color: var(--secondary);
      display: -webkit-box;
      -webkit-box-orient: vertical;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }
    
    .message-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .message-email {
      font-size: 0.75rem;
      color: var(--secondary);
    }
    
    .message-badge {
      padding: 0.125rem 0.5rem;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 500;
    }
    
    .badge-unread {
      background: rgba(255,62,29,0.1);
      color: var(--danger);
    }
    
    .badge-read {
      background: rgba(113,221,55,0.1);
      color: var(--success);
    }

    /* Message detail */
    .message-detail {
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .detail-header {
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .detail-sender {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 0.5rem;
    }
    
    .detail-email {
      color: var(--primary);
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }
    
    .detail-phone {
      color: var(--secondary);
      font-size: 0.9rem;
    }
    
    .detail-subject {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--dark);
      margin: 0.5rem 0;
    }
    
    .detail-message {
      padding: 1rem;
      background: var(--light);
      border-radius: 6px;
      line-height: 1.5;
      white-space: pre-wrap;
      flex: 1;
    }
    
    .detail-footer {
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .detail-date {
      font-size: 0.85rem;
      color: var(--secondary);
    }
    
    .detail-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* Empty states */
    .empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--secondary);
    }
    
    .empty-state i {
      font-size: 2rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* Quick stats */
    .quick-stats {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    .stat-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: white;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      font-size: 0.85rem;
    }
    
    .stat-count {
      font-weight: 600;
      color: var(--dark);
    }
    
    .stat-label {
      color: var(--secondary);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      max-width: 400px;
      width: 90%;
    }
    
    .modal-header {
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      font-size: 1.1rem;
      color: var(--dark);
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: var(--secondary);
    }
    
    .modal-footer {
      margin-top: 1.5rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }

    /* Loading */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-color);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .main-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .header-right {
        flex-direction: column;
        align-items: stretch;
      }
      
      .search-box {
        width: 100%;
      }
      
      .tabs {
        overflow-x: auto;
      }
      
      .tab {
        padding: 0.75rem 1rem;
        white-space: nowrap;
      }
      
      .quick-stats {
        justify-content: center;
      }
    }
    
    @media (max-width: 480px) {
      .detail-footer {
        flex-direction: column;
        gap: 0.75rem;
        align-items: flex-start;
      }
      
      .detail-actions {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>

<body>

<!-- LOAD SIDEBAR -->
<div id="sidebar-container"></div>

<!-- Mobile Overlay -->
<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

<!-- Mobile Toggle -->
<button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

<!-- MAIN CONTENT -->
<div class="container">

  <!-- Header -->
  <header class="main-header">
    <div class="header-left">
      <h1><i class="fas fa-envelope"></i> Customer Messages</h1>
    </div>
    <div class="header-right">
      <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-input" id="searchInput" placeholder="Search messages...">
      </div>
      <button class="btn btn-primary" onclick="refreshMessages()">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
    </div>
  </header>

  <!-- Quick Stats -->
  <div class="quick-stats">
    <div class="stat-item">
      <i class="fas fa-inbox" style="color: var(--primary);"></i>
      <span class="stat-count" id="totalCount">0</span>
      <span class="stat-label">Total</span>
    </div>
    <div class="stat-item">
      <i class="fas fa-envelope" style="color: var(--danger);"></i>
      <span class="stat-count" id="unreadCount">0</span>
      <span class="stat-label">Unread</span>
    </div>
    <div class="stat-item">
      <i class="fas fa-envelope-open" style="color: var(--success);"></i>
      <span class="stat-count" id="readCount">0</span>
      <span class="stat-label">Read</span>
    </div>
    <div class="stat-item">
      <button class="btn btn-sm btn-outline" onclick="markAllAsRead()">
        <i class="fas fa-check-double"></i> Mark All Read
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content-area">
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('all')">All Messages</button>
      <button class="tab" onclick="switchTab('unread')">Unread</button>
      <button class="tab" onclick="switchTab('read')">Read</button>
    </div>

    <!-- Messages Grid -->
    <div class="messages-grid">
      <!-- Message List -->
      <div class="message-list">
        <div class="message-list-header">
          <span style="font-weight: 500;">Messages</span>
          <span class="text-muted" style="font-size: 0.85rem;" id="listCount">0</span>
        </div>
        <div class="message-list-body" id="messageList">
          <!-- Loading state -->
          <div class="loading">
            <div class="loading-spinner"></div>
          </div>
        </div>
      </div>

      <!-- Message Detail -->
      <div class="message-detail" id="messageDetail">
        <div class="empty-state">
          <i class="fas fa-envelope-open"></i>
          <p>Select a message to view details</p>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Delete Modal -->
<div class="modal" id="deleteModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title"><i class="fas fa-trash"></i> Delete Message</h3>
      <button class="close-btn" onclick="closeModal('deleteModal')">&times;</button>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to delete this message?</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
      <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<script>
// Global variables
let messages = [];
let currentMessage = null;
let currentTab = 'all';
let messageToDelete = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
  enforceLogin();
  loadSidebar();
  loadMessages();
  setupEventListeners();
});

// Enforce login
function enforceLogin() {
  const appId = localStorage.getItem("app_id");
  if (!appId) {
    window.location.replace("login.html");
  }
}


// ========== SIDEBAR FUNCTIONS ==========
function loadSidebar() {
    fetch("sidebar.html")
        .then(r => r.text())
        .then(html => {
            document.getElementById("sidebar-container").innerHTML = html;
            
            // Initialize sidebar after a short delay
            setTimeout(() => {
                initializeSidebar();
            }, 100);
        })
        .catch(err => {
            console.error("Error loading sidebar:", err);
        });
}

function initializeSidebar() {
    const currentPage = window.location.pathname.split('/').pop();
    
    // 1. Highlight all nav items
    document.querySelectorAll('.nav-item').forEach(item => {
        if (item.getAttribute('href') === currentPage) {
            item.classList.add('active');
        }
    });
    
    // 2. Initialize ALL collapsible sections
    const collapsibleHeaders = document.querySelectorAll('.collapsible-header');
    
    collapsibleHeaders.forEach(header => {
        const section = header.closest('.collapsible-section');
        if (!section) return;
        
        const content = section.querySelector('.collapsible-content');
        if (!content) return;
        
        // Check if this section should be expanded
        let shouldExpand = false;
        const links = section.querySelectorAll('a');
        
        links.forEach(link => {
            if (link.getAttribute('href') === currentPage) {
                link.classList.add('active');
                shouldExpand = true;
            }
        });
        
        // Auto-expand if needed
        if (shouldExpand) {
            header.classList.add('active');
            content.classList.add('expanded');
        }
        
        // Clone header to prevent duplicate event listeners
        const newHeader = header.cloneNode(true);
        header.parentNode.replaceChild(newHeader, header);
        
        // Add toggle click event
        newHeader.addEventListener('click', function() {
            this.classList.toggle('active');
            content.classList.toggle('expanded');
        });
    });
    
    // 3. Initialize mobile sidebar toggle
    const toggleBtn = document.querySelector('.menu-toggle');
    const overlay = document.getElementById('overlay');
    const sidebar = document.getElementById('sidebar');
    
    if (toggleBtn && sidebar) {
        toggleBtn.addEventListener('click', function() {
            sidebar.classList.toggle('active');
            if (overlay) overlay.classList.toggle('active');
        });
    }
    
    if (overlay && sidebar) {
        overlay.addEventListener('click', function() {
            sidebar.classList.remove('active');
            this.classList.remove('active');
        });
    }
}

function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");
    if (sidebar) {
        sidebar.classList.toggle("active");
        if (overlay) overlay.classList.toggle("active");
    }
}

// ========== INITIALIZE ==========
enforceLogin();
document.addEventListener('DOMContentLoaded', function() {
    loadSidebar();
});

// Setup event listeners
function setupEventListeners() {
  // Search
  document.getElementById('searchInput').addEventListener('input', filterMessages);
}

// Load messages from API
async function loadMessages() {
  try {
    const app_id = localStorage.getItem('app_id');
    
    if (!app_id) {
      console.error('No app_id found in localStorage');
      return;
    }
    
    // Show loading
    document.getElementById('messageList').innerHTML = `
      <div class="loading">
        <div class="loading-spinner"></div>
      </div>
    `;
    
    // Send request in JSON format
    const response = await fetch('https://www.coremicron.co.in/skynetwork/admin/messages.php', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        app_id: app_id,
        action: 'get_messages'
      })
    });
    
    const data = await response.json();
    console.log('API Response:', data); // For debugging
    
    if (data.result === "1") {
      // Parse the API response
      messages = data.messages.map(msg => {
        // Your API returns status as 'read' or 'unread' string
        // Make sure we handle both uppercase and lowercase
        const status = (msg.status || 'unread').toLowerCase();
        const isRead = status === 'viewed';
        
        return {
          id: msg.id,
          name: msg.name || 'Unknown',
          email: msg.email || 'No email',
          phone: msg.phone || 'Not provided',
          message: msg.message || 'No message content',
          status: isRead ? 'read' : 'unread', // Use the status from API
          created_at: parseDate(msg.date), // Convert date format
          date_display: msg.date || 'Unknown date',
          is_read: isRead // Boolean value
        };
      });
      
      // Sort by date (newest first)
      messages.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      
      updateDisplay();
    } else {
      console.error('API returned error result');
      showError('Failed to load messages. Please try again.');
    }
    
  } catch (error) {
    console.error('Error loading messages:', error);
    showError('Network error. Please check your connection.');
  }
}

// Parse date from "dd/mm/yyyy hh:mm AM/PM" format
function parseDate(dateString) {
  if (!dateString) return new Date().toISOString();
  
  try {
    // Split date and time
    const parts = dateString.split(' ');
    if (parts.length < 2) return new Date().toISOString();
    
    const datePart = parts[0]; // "dd/mm/yyyy"
    const timePart = parts[1] + (parts[2] ? ' ' + parts[2] : ''); // "hh:mm" or "hh:mm AM/PM"
    
    // Parse date
    const [day, month, year] = datePart.split('/').map(num => parseInt(num, 10));
    
    // Parse time
    let hours = 0, minutes = 0;
    
    if (timePart.includes(':')) {
      let [time, modifier] = timePart.split(' ');
      let [h, m] = time.split(':').map(num => parseInt(num, 10));
      
      hours = h || 0;
      minutes = m || 0;
      
      // Convert to 24-hour format if AM/PM is present
      if (modifier) {
        if (modifier.toLowerCase() === 'pm' && hours < 12) {
          hours += 12;
        }
        if (modifier.toLowerCase() === 'am' && hours === 12) {
          hours = 0;
        }
      }
    }
    
    // Create Date object (month is 0-indexed in JavaScript)
    const date = new Date(year, month - 1, day, hours, minutes);
    return date.toISOString();
  } catch (error) {
    console.error('Error parsing date:', error, dateString);
    return new Date().toISOString();
  }
}

// Show error
function showError(message) {
  document.getElementById('messageList').innerHTML = `
    <div class="empty-state">
      <i class="fas fa-exclamation-circle" style="color: var(--danger);"></i>
      <p>${message}</p>
      <button class="btn btn-primary btn-sm" onclick="loadMessages()" style="margin-top: 1rem;">
        <i class="fas fa-redo"></i> Retry
      </button>
    </div>
  `;
}

// Update display
function updateDisplay() {
  updateStats();
  filterMessages();
}

// Update statistics
function updateStats() {
  const total = messages.length;
  const unread = messages.filter(m => m.status === 'unread').length;
  const read = messages.filter(m => m.status === 'read').length;
  
  document.getElementById('totalCount').textContent = total;
  document.getElementById('unreadCount').textContent = unread;
  document.getElementById('readCount').textContent = read;
}

// Filter messages
function filterMessages() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  
  let filtered = messages;
  
  // Apply tab filter
  if (currentTab === 'unread') {
    filtered = filtered.filter(m => m.status === 'unread');
  } else if (currentTab === 'read') {
    filtered = filtered.filter(m => m.status === 'read');
  }
  
  // Apply search filter
  if (searchTerm) {
    filtered = filtered.filter(m => 
      (m.name && m.name.toLowerCase().includes(searchTerm)) ||
      (m.email && m.email.toLowerCase().includes(searchTerm)) ||
      (m.phone && m.phone.toLowerCase().includes(searchTerm)) ||
      (m.message && m.message.toLowerCase().includes(searchTerm))
    );
  }
  
  displayMessageList(filtered);
}

// Display message list
function displayMessageList(messagesList) {
  const list = document.getElementById('messageList');
  const count = document.getElementById('listCount');
  
  if (messagesList.length === 0) {
    list.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><p>No messages found</p></div>';
    count.textContent = '0 messages';
    return;
  }
  
  list.innerHTML = messagesList.map(msg => `
    <div class="message-item ${msg.status === 'unread' ? 'unread' : ''} ${currentMessage && currentMessage.id === msg.id ? 'active' : ''}" 
         onclick="selectMessage('${msg.id}')">
      <div class="message-header">
        <div class="message-sender">${escapeHtml(msg.name)}</div>
        <div class="message-time">${formatTime(msg.created_at)}</div>
      </div>
      <div class="message-preview">${truncateMessage(msg.message, 50)}</div>
      <div class="message-footer">
        <div class="message-email">${truncateEmail(msg.email)}</div>
        <div class="message-badge ${msg.status === 'unread' ? 'badge-unread' : 'badge-read'}">
          ${msg.status === 'unread' ? 'Unread' : 'Read'}
        </div>
      </div>
    </div>
  `).join('');
  
  count.textContent = `${messagesList.length} message${messagesList.length !== 1 ? 's' : ''}`;
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Truncate message for preview
function truncateMessage(message, length) {
  if (!message) return 'No message';
  const escaped = escapeHtml(message);
  if (escaped.length <= length) return escaped;
  return escaped.substring(0, length) + '...';
}

// Truncate email for display
function truncateEmail(email, length = 20) {
  if (!email) return 'No email';
  const escaped = escapeHtml(email);
  if (escaped.length <= length) return escaped;
  return escaped.substring(0, length) + '...';
}

// Select message
async function selectMessage(id) {
  const message = messages.find(m => m.id === id);
  if (!message) return;
  
  currentMessage = message;
  
  // Update active state
  document.querySelectorAll('.message-item').forEach(item => {
    item.classList.remove('active');
  });
  
  const selectedItem = document.querySelector(`.message-item[onclick="selectMessage('${id}')"]`);
  if (selectedItem) {
    selectedItem.classList.add('active');
  }
  
  // Mark as read if unread via API
  if (message.status === 'unread') {
    await markMessageAsRead(id);
  }
  
  // Display message detail
  displayMessageDetail(message);
}

// Mark message as read via API
async function markMessageAsRead(messageId) {
  try {
    const app_id = localStorage.getItem('app_id');
    
    if (!app_id) {
      console.error('No app_id found');
      return;
    }
    
    console.log('Marking message as read:', messageId);
    
    // Call the API to permanently mark message as read
    const response = await fetch('https://www.coremicron.co.in/skynetwork/admin/action/messages.php', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        app_id: app_id,
        msgid: messageId
      })
    });
    
    const data = await response.json();
    console.log('Mark as read response:', data);
    
    if (data.result === "1") {
      // Update local message status
      const message = messages.find(m => m.id === messageId);
      if (message) {
        message.status = 'read';
        message.is_read = true;
        
        // Update the UI immediately
        updateDisplay();
        
        // Show success message
        console.log(`Message ${messageId} marked as read successfully`);
      }
    } else {
      console.error('Error marking message as read:', data.error || 'Unknown error');
      alert('Failed to mark message as read. Please try again.');
    }
    
  } catch (error) {
    console.error('Error marking message as read:', error);
    alert('Network error. Please check your connection.');
  }
}

// Display message detail
function displayMessageDetail(message) {
  const detail = document.getElementById('messageDetail');
  
  detail.innerHTML = `
    <div class="detail-header">
      <div class="detail-sender">${escapeHtml(message.name)}</div>
      <div class="detail-email">
        <i class="fas fa-envelope"></i> ${escapeHtml(message.email)}
      </div>
      <div class="detail-phone">
        <i class="fas fa-phone"></i> ${escapeHtml(message.phone)}
      </div>
    </div>
    
    <div class="detail-message">
      <div style="color: var(--dark); font-weight: 500; margin-bottom: 0.5rem;">Message:</div>
      ${escapeHtml(message.message).replace(/\n/g, '<br>')}
    </div>
    
    <div class="detail-footer">
      <div class="detail-date">
        <i class="fas fa-clock"></i> Received: ${escapeHtml(message.date_display)}
      </div>
      <div class="detail-actions">
        <button class="btn btn-outline btn-sm" onclick="openDeleteModal()">
          <i class="fas fa-trash"></i> Delete
        </button>
      </div>
    </div>
  `;
}

// Format time
function formatTime(dateString) {
  try {
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    const hours = Math.floor(diff / (1000 * 60 * 60));
    
    if (hours < 24) {
      return `${hours}h ago`;
    } else {
      return date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
    }
  } catch (error) {
    return 'Recent';
  }
}

// Switch tab
function switchTab(tab) {
  currentTab = tab;
  
  // Update active tab
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
  
  filterMessages();
}

// Open delete modal
function openDeleteModal() {
  if (!currentMessage) return;
  
  messageToDelete = currentMessage.id;
  openModal('deleteModal');
}

// Confirm delete via API
async function confirmDelete() {
  if (!messageToDelete) return;
  
  try {
    const app_id = localStorage.getItem('app_id');
    
    const response = await fetch('https://www.coremicron.co.in/skynetwork/admin/action/messages.php', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        app_id: app_id,
        action: 'delete',
        msgid: messageToDelete
      })
    });
    
    const data = await response.json();
    
    if (data.result === "1") {
      // Remove from local messages
      messages = messages.filter(m => m.id !== messageToDelete);
      currentMessage = null;
      
      updateDisplay();
      closeModal('deleteModal');
      
      // Clear detail view
      document.getElementById('messageDetail').innerHTML = `
        <div class="empty-state">
          <i class="fas fa-envelope-open"></i>
          <p>Select a message to view details</p>
        </div>
      `;
      
      alert('Message deleted successfully!');
    } else {
      alert('Error deleting message: ' + (data.error || 'Unknown error'));
    }
    
  } catch (error) {
    console.error('Error deleting message:', error);
    alert('Network error. Please try again.');
  }
}

// Mark all as read via API
async function markAllAsRead() {
  try {
    const app_id = localStorage.getItem('app_id');
    
    // Get all unread messages
    const unreadMessages = messages.filter(m => m.status === 'unread');
    
    if (unreadMessages.length === 0) {
      alert('No unread messages to mark as read.');
      return;
    }
    
    // Confirm with user
    if (!confirm(`Are you sure you want to mark all ${unreadMessages.length} unread messages as read?`)) {
      return;
    }
    
    let successCount = 0;
    let failedCount = 0;
    
    // Mark each unread message as read via API
    for (const message of unreadMessages) {
      try {
        const response = await fetch('https://www.coremicron.co.in/skynetwork/admin/action/messages.php', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            app_id: app_id,
            msgid: message.id
          })
        });
        
        const data = await response.json();
        
        if (data.result === "1") {
          successCount++;
          // Update local message status
          message.status = 'read';
          message.is_read = true;
        } else {
          failedCount++;
          console.error(`Failed to mark message ${message.id} as read:`, data.error);
        }
      } catch (error) {
        failedCount++;
        console.error(`Error marking message ${message.id} as read:`, error);
      }
    }
    
    // Update UI
    updateDisplay();
    
    if (successCount > 0) {
      alert(`Successfully marked ${successCount} message${successCount !== 1 ? 's' : ''} as read!${failedCount > 0 ? ` (${failedCount} failed)` : ''}`);
    } else {
      alert('Failed to mark messages as read. Please try again.');
    }
    
  } catch (error) {
    console.error('Error marking all as read:', error);
    alert('Network error. Please try again.');
  }
}

// Refresh messages
function refreshMessages() {
  loadMessages();
}

// Modal functions
function openModal(modalId) {
  document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('active');
}

// Toggle sidebar
function toggleSidebar() {
  const sidebar = document.getElementById("sidebar");
  const overlay = document.getElementById("overlay");
  if (sidebar) {
    sidebar.classList.toggle("active");
    overlay.classList.toggle("active");
  }
}
</script>

</body>
</html>
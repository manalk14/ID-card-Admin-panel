<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dealer Management | Dashboard</title>
   <link rel="stylesheet" href="fontawesome-free-7.1.0-web/fontawesome-free-7.1.0-web/css/all.min.css"/>

    <!-- Sidebar CSS file -->
    <link rel="stylesheet" href="sidebar.css">

    <style>
        :root {
            --primary:#696cff;--primary-dark:#5f61e6;--secondary:#8592a3;
            --success:#71dd37;--warning:#ffab00;--danger:#ff3e1d;
            --info:#03c3ec;--dark:#233446;--light:#f5f5f9;
            --border-color:#d9dee3;--card-bg:#fff;--body-bg:#f5f5f9;
        }

        body {
            background:var(--body-bg);
            font-family:'Segoe UI', system-ui, sans-serif;
            min-height:10vh;
            color:#697a8d;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* Main content layout */
        .container {
            max-width:1000px;
            margin-left:240px;
            padding:2rem;
            transition:margin-left .3s;
        }

        @media(max-width:992px){
            .container{margin-left:0;}
        }

        /* Mobile Sidebar Toggle */
        .menu-toggle{
            display:none;position:fixed;top:20px;left:20px;z-index:2000;
            background:var(--primary);color:white;border:none;padding:10px 14px;
            border-radius:6px;font-size:18px;cursor:pointer;
        }

        @media(max-width:992px){.menu-toggle{display:block;}}

        .overlay{
            display:none;position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,.5);backdrop-filter:blur(3px);z-index:1200;
        }
        .overlay.active {display:block;}

        /* Header */
        .main-header{
            background:white;
            border-radius:.625rem;
            padding:1rem;
            margin-bottom:1.5rem;
            display:flex;
            justify-content:space-between;
            align-items:center;
            box-shadow:0 2px 6px rgba(165,163,174,.1);
            flex-wrap:wrap;gap:1rem;
        }
       .main-header h1 {
      font-size: 1.7rem;
      color: var(--dark);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.7rem;
    }

        .page-title h1{
            font-size:1.75rem;color:var(--dark);
            display:flex;align-items:center;gap:.7rem;font-weight:600;
        }

        /* Search Box */
        .search-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .search-box {
            position: relative;
            min-width: 300px;
        }
        
        .search-box input {
            width: 80%;
            padding: .75rem 1rem .75rem 2.5rem;
            border-radius: .5rem;
            border: 1px solid var(--dark);
            font-size: 0.875rem;
            transition: border-color .2s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(105,108,255,.1);
        }
        
        .search-box i {
            position: absolute;
            left: .75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary);
        }

        .btn{
            padding:.6rem 1.2rem;border-radius:.4rem;border:none;cursor:pointer;
            display:inline-flex;align-items:center;gap:.5rem;
            transition:all .2s ease;
        }
        .btn-primary{background:var(--primary);color:white;}
        .btn-primary:hover{background:var(--primary-dark);}
        .btn-outline{border:1px solid var(--primary);color:var(--primary);background:transparent;}

        .stats-grid{
            display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));
            gap:1rem;margin-bottom:1.5rem;
        }

        .stat-card{
            background:white;border-radius:.625rem;padding:1.3rem;
            box-shadow:0 2px 6px rgba(165,163,174,.1);border:1px solid var(--border-color);
        }
        .stat-card h3{font-size:1.8rem;margin:0;color:var(--dark);}
        .stat-card p{color:var(--secondary);margin:.5rem 0 0;}

        .card{background:white;border:1px solid var(--border-color);
            border-radius:.625rem;margin-bottom:1.5rem;}
        .card-header{
            padding:1.5rem;border-bottom:1px solid var(--border-color);
            display:flex;justify-content:space-between;align-items:center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .card-header h5{margin:0;font-size:1.25rem;color:var(--dark);}
        .card-body{padding:1.5rem;}

        .table-responsive{overflow-x:auto;}
        table{width:100%;border-collapse:collapse;}
        th,td{padding:1rem;border-bottom:1px solid var(--border-color);text-align:left;}
        thead{background:#f7f7fb;}
        tbody tr:hover{background:#f7f7fb;}

        .badge{
            padding:.25rem .75rem;border-radius:1rem;font-size:.75rem;font-weight:500;
        }
        .badge-success{background:rgba(113,221,55,.15);color:var(--success);}
        .badge-warning{background:rgba(255,171,0,.15);color:var(--warning);}
        .badge-danger{background:rgba(255,62,29,.1);color:var(--danger);}
        .badge-primary{background:rgba(105,108,255,.15);color:var(--primary);}

        /* Action Menu */
        .action-menu {
            position:relative;
        }
        .action-btn {
            background:none;border:none;cursor:pointer;
            padding:.5rem;font-size:1.2rem;color:var(--secondary);
            transition:color .2s;
        }
        .action-btn:hover {
            color:var(--primary);
        }
        .action-dropdown {
            display:none;
            position:absolute;
            right:0;
            top:100%;
            background:white;
            border:1px solid var(--border-color);
            border-radius:.5rem;
            box-shadow:0 4px 12px rgba(0,0,0,.1);
            min-width:160px;
            z-index:100;
        }
        .action-dropdown.show {
            display:block;
        }
        .action-item {
            display:flex;align-items:center;gap:.75rem;
            padding:.75rem 1rem;cursor:pointer;transition:background .2s;
            border:none;background:none;width:100%;text-align:left;
        }
        .action-item:hover {
            background:var(--light);
        }
        .action-item.view {color:var(--info);}
        .action-item.edit {color:var(--warning);}
        .action-item.delete {color:var(--danger);}
        .action-item.block {color:var(--dark);}
        .action-item.unblock {color:var(--success);}

        /* Modal Styles */
        .modal {
            display:none;
            position:fixed;
            top:0;left:0;
            width:100%;height:100%;
            background:rgba(0,0,0,.5);
            z-index:2000;
            align-items:center;
            justify-content:center;
        }
        .modal.active {
            display:flex;
        }
        .modal-content {
            background:white;
            border-radius:.75rem;
            width:90%;
            max-width:500px;
            max-height:90vh;
            overflow-y:auto;
            box-shadow:0 8px 24px rgba(0,0,0,.15);
        }
        .modal-header {
            padding:1.5rem;border-bottom:1px solid var(--border-color);
            display:flex;justify-content:space-between;align-items:center;
        }
        .modal-header h3 {
            margin:0;color:var(--dark);
        }
        .close-btn {
            background:none;border:none;font-size:1.5rem;cursor:pointer;
            color:var(--secondary);padding:0;width:30px;height:30px;
            display:flex;align-items:center;justify-content:center;
        }
        .close-btn:hover {
            color:var(--danger);
        }
        .modal-body {
            padding:1.5rem;
        }
        .form-group {
            margin-bottom:1.25rem;
        }
        .form-label {
            display:block;margin-bottom:.5rem;color:var(--dark);
            font-weight:500;
        }
        .form-control {
            width:94%;padding:.75rem 1rem;border-radius:.5rem;
            border:1px solid var(--border-color);font-size:1rem;
            transition:border-color .2s;
        }
        .form-control:focus {
            outline:none;border-color:var(--primary);
            box-shadow:0 0 0 3px rgba(105,108,255,.1);
        }
        textarea.form-control {
            min-height:100px;resize:vertical;
        }
        .form-row {
            display:grid;grid-template-columns:1fr 1fr;gap:1rem;
        }
        .modal-footer {
            padding:1.5rem;border-top:1px solid var(--border-color);
            display:flex;justify-content:flex-end;gap:1rem;
        }
        .btn-cancel {
            background:transparent;border:1px solid var(--secondary);
            color:var(--secondary);
        }
        .btn-cancel:hover {
            background:#f7f7fb;
        }

        .footer{
            text-align:center;padding:1.5rem;background:white;border-radius:.625rem;
            margin-top:1rem;color:var(--secondary);
        }
        
        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(105,108,255,.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--secondary);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--border-color);
        }
        
        .empty-state h4 {
            margin: 0 0 0.5rem;
            color: var(--dark);
            font-size: 1.25rem;
        }
        
        .empty-state p {
            margin: 0;
            font-size: 0.875rem;
        }
        
        /* Refresh Button */
        .btn-refresh {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--secondary);
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-refresh:hover {
            background: var(--light);
            color: var(--primary);
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background: var(--success);
        }
        
        .toast.error {
            background: var(--danger);
        }
        
        .toast.info {
            background: var(--info);
        }
        
   
        
        /* Save Button Loading State */
        .btn-saving .spinner {
            margin-right: 8px;
        }
        
        /* Confirmation Modal */
        .confirmation-modal .modal-content {
            max-width: 400px;
        }
        
        .confirmation-modal .modal-body {
            text-align: center;
            padding: 2rem 1.5rem;
        }
        
        .confirmation-icon {
            font-size: 3rem;
            color: var(--danger);
            margin-bottom: 1.5rem;
        }
        
        .confirmation-text {
            color: var(--dark);
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        
        .confirmation-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .btn-confirm-delete {
            background: var(--danger);
            color: white;
        }
        
        .btn-confirm-delete:hover {
            background: #e02d1b;
        }
        
        /* Block/Unblock Confirmation Modal */
        .block-confirmation-modal .modal-content {
            max-width: 400px;
        }
        
        .block-confirmation-modal .modal-body {
            text-align: center;
            padding: 2rem 1.5rem;
        }
        
        .block-confirmation-icon {
            font-size: 3rem;
            margin-bottom: 1.5rem;
        }
        
        .block-confirmation-icon.block {
            color: var(--warning);
        }
        
        .block-confirmation-icon.unblock {
            color: var(--success);
        }
        
        .block-confirmation-text {
            color: var(--dark);
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        
        .block-confirmation-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .btn-confirm-block {
            background: var(--warning);
            color: white;
        }
        
        .btn-confirm-unblock {
            background: var(--success);
            color: white;
        }
        
        .btn-confirm-block:hover {
            background: #ff1e00;
        }
        
        .btn-confirm-unblock:hover {
            background: #5fc62e;
        }
        
        /* Pagination Container - Same style as template management */
        .pagination-container {
            background: white;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .pagination-info {
            color: var(--secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .pagination-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .pagination-info {
                margin-bottom: 0;
            }
            
            .pagination-buttons {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Pagination buttons container */
        .pagination-buttons {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            flex-wrap: wrap;
        }
        
        /* Page size selector */
        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 1rem;
        }
        
        .page-size-selector select {
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            background: white;
            color: var(--dark);
            font-size: 0.875rem;
        }
        
        .page-size-selector select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* Last updated timestamp */
        .last-updated {
            color: var(--secondary);
            font-size: 0.875rem;
            margin-right: 1rem;
        }
    </style>
</head>

<body>

<!-- Toast Notification Container -->
<div id="toastContainer"></div>

<!-- Delete Confirmation Modal -->
<div class="modal confirmation-modal" id="deleteConfirmationModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Confirm Deletion</h3>
            <button class="close-btn" onclick="closeModal('deleteConfirmationModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="confirmation-icon">
                <i class="fas fa-trash-alt"></i>
            </div>
            <div class="confirmation-text" id="deleteConfirmationText">
                Are you sure you want to delete this dealer?
            </div>
            <div class="confirmation-buttons">
                <button class="btn btn-cancel" onclick="closeModal('deleteConfirmationModal')">Cancel</button>
                <button class="btn btn-confirm-delete" id="confirmDeleteBtn" onclick="confirmDelete()">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Block/Unblock Confirmation Modal -->
<div class="modal block-confirmation-modal" id="blockConfirmationModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="blockModalTitle"><i class="fas fa-exclamation-triangle"></i> Confirm Action</h3>
            <button class="close-btn" onclick="closeModal('blockConfirmationModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="block-confirmation-icon" id="blockConfirmationIcon">
                <i class="fas fa-ban"></i>
            </div>
            <div class="block-confirmation-text" id="blockConfirmationText">
                Are you sure you want to perform this action?
            </div>
            <div class="block-confirmation-buttons">
                <button class="btn btn-cancel" onclick="closeModal('blockConfirmationModal')">Cancel</button>
                <button class="btn" id="confirmBlockBtn" onclick="confirmBlockUnblock()">
                    <i class="fas fa-check"></i> Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Sidebar Loaded Dynamically -->
<div id="sidebar-container"></div>

<!-- Mobile overlay -->
<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

<!-- Sidebar toggle button for mobile -->
<button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

<!-- MAIN CONTENT -->
<div class="container">

    <header class="main-header">
        <div class="page-title">
            <h1><i class="fas fa-users"></i> Dealer Management</h1>
        </div>
        <div class="search-container">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search dealers by name, email, or phone..." onkeyup="filterDealers()">
            </div>
            <button class="btn btn-primary" id="addDealerBtn">
                <i class="fas fa-user-plus"></i> Add Dealer
            </button>
        </div>
    </header>

    <div class="stats-grid">
        <div class="stat-card"><h3 id="totalDealers">0</h3><p>Total Dealers</p></div>
        <div class="stat-card"><h3 id="activeDealers">0</h3><p>Active Dealers</p></div>
        <div class="stat-card"><h3 id="blockedDealers">0</h3><p>Blocked Dealers</p></div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5>Dealer List</h5>
            <div class="d-flex align-items-center gap-2">
                <span class="last-updated" id="lastUpdated"></span>
                <button class="btn btn-outline btn-refresh" onclick="loadDealers()" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th class="serial-no">SL no.</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="6" style="text-align:center;padding:2rem;">
                                <span class="spinner"></span> Loading dealers...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Container - Same as template management -->
            <div class="pagination-container" id="paginationContainer" style="display: none;">
                <div class="text-muted small mb-2 mb-md-0" id="paginationInfo">
                    Showing 0 to 0 of 0 entries
                </div>
                <div class="d-flex align-items-center gap-3 flex-wrap">
                    <div class="d-flex align-items-center gap-2">
                        <span class="small">Show</span>
                        <select class="form-select form-select-sm w-auto" id="pageSizeSelect">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                        <span class="small">entries</span>
                    </div>
                    <div class="pagination-buttons d-flex gap-1" id="paginationButtons">
                        <!-- Pagination buttons will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">Dealer Management Â© 2023</footer>

</div>

<!-- Add Dealer Modal -->
<div class="modal" id="addDealerModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user-plus"></i> Add New Dealer</h3>
            <button class="close-btn" onclick="closeModal('addDealerModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addDealerForm">
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-control" id="addName" placeholder="Enter dealer name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address *</label>
                    <input type="email" class="form-control" id="addEmail" placeholder="Enter email address" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number *</label>
                    <input type="tel" class="form-control" id="addPhone" placeholder="Enter phone number" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password *</label>
                    <input type="password" class="form-control" id="addPassword" placeholder="Create password (min. 6 characters)" required minlength="6">
                </div>
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <textarea class="form-control" id="addAddress" placeholder="Enter full address" rows="3"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-cancel" onclick="closeModal('addDealerModal')">Cancel</button>
            <button class="btn btn-primary" id="saveDealerBtn" onclick="saveDealer()">
                <i class="fas fa-save"></i> Save Dealer
            </button>
        </div>
    </div>
</div>

<!-- View Dealer Modal -->
<div class="modal" id="viewDealerModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-eye"></i> Dealer Details</h3>
            <button class="close-btn" onclick="closeModal('viewDealerModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="dealerDetails">
                <div style="text-align:center;padding:2rem;">
                    <span class="spinner"></span> Loading details...
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closeModal('viewDealerModal')">Close</button>
        </div>
    </div>
</div>

<!-- Edit Dealer Modal -->
<div class="modal" id="editDealerModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Edit Dealer</h3>
            <button class="close-btn" onclick="closeModal('editDealerModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editDealerForm">
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-control" id="editName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address *</label>
                    <input type="email" class="form-control" id="editEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number *</label>
                    <input type="tel" class="form-control" id="editPhone" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <textarea class="form-control" id="editAddress" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">New Password (Optional)</label>
                        <input type="password" class="form-control" id="editPassword" placeholder="Leave blank to keep current password">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-cancel" onclick="closeModal('editDealerModal')">Cancel</button>
            <button class="btn btn-primary" id="updateDealerBtn" onclick="updateDealer()">
                <i class="fas fa-save"></i> Update Dealer
            </button>
        </div>
    </div>
</div>


<script>
   function enforceLogin() {
    const appId = localStorage.getItem("app_id");

    // If app_id is not found, redirect immediately
    if (!appId) {
        window.location.replace("login.html");
    }
}

// Call it as soon as the script loads
enforceLogin();


// ========== API CONFIGURATION ==========
const API_BASE_URL = 'https://www.coremicron.co.in/skynetwork/admin';
let allDealersData = [];
let filteredDealersData = [];
let currentDealerId = null;
let dealerToDelete = null;
let dealerToToggleStatus = null;
let isBlockAction = true; // true for block, false for unblock

// ========== PAGINATION VARIABLES ==========
let currentPage = 1;
let pageSize = 10;
let totalDealers = 0;

// Toast notification function
function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    let icon = 'fa-check-circle';
    if (type === 'error') icon = 'fa-exclamation-circle';
    if (type === 'info') icon = 'fa-info-circle';
    if (type === 'warning') icon = 'fa-exclamation-triangle';
    
    toast.innerHTML = `
        <i class="fas ${icon}"></i>
        <span>${message}</span>
    `;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 10);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 3000);
}

/* Load Sidebar from File */

// ========== SIDEBAR FUNCTIONS ==========
function loadSidebar() {
    fetch("sidebar.html")
        .then(r => r.text())
        .then(html => {
            document.getElementById("sidebar-container").innerHTML = html;
            
            // Initialize sidebar after a short delay
            setTimeout(() => {
                initializeSidebar();
            }, 100);
        })
        .catch(err => {
            console.error("Error loading sidebar:", err);
        });
}

function initializeSidebar() {
    const currentPage = window.location.pathname.split('/').pop();
    
    // 1. Highlight all nav items
    document.querySelectorAll('.nav-item').forEach(item => {
        if (item.getAttribute('href') === currentPage) {
            item.classList.add('active');
        }
    });
    
    // 2. Initialize ALL collapsible sections
    const collapsibleHeaders = document.querySelectorAll('.collapsible-header');
    
    collapsibleHeaders.forEach(header => {
        const section = header.closest('.collapsible-section');
        if (!section) return;
        
        const content = section.querySelector('.collapsible-content');
        if (!content) return;
        
        // Check if this section should be expanded
        let shouldExpand = false;
        const links = section.querySelectorAll('a');
        
        links.forEach(link => {
            if (link.getAttribute('href') === currentPage) {
                link.classList.add('active');
                shouldExpand = true;
            }
        });
        
        // Auto-expand if needed
        if (shouldExpand) {
            header.classList.add('active');
            content.classList.add('expanded');
        }
        
        // Clone header to prevent duplicate event listeners
        const newHeader = header.cloneNode(true);
        header.parentNode.replaceChild(newHeader, header);
        
        // Add toggle click event
        newHeader.addEventListener('click', function() {
            this.classList.toggle('active');
            content.classList.toggle('expanded');
        });
    });
    
    // 3. Initialize mobile sidebar toggle
    const toggleBtn = document.querySelector('.menu-toggle');
    const overlay = document.getElementById('overlay');
    const sidebar = document.getElementById('sidebar');
    
    if (toggleBtn && sidebar) {
        toggleBtn.addEventListener('click', function() {
            sidebar.classList.toggle('active');
            if (overlay) overlay.classList.toggle('active');
        });
    }
    
    if (overlay && sidebar) {
        overlay.addEventListener('click', function() {
            sidebar.classList.remove('active');
            this.classList.remove('active');
        });
    }
}

function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");
    if (sidebar) {
        sidebar.classList.toggle("active");
        if (overlay) overlay.classList.toggle("active");
    }
}

// ========== INITIALIZE ==========
enforceLogin();
document.addEventListener('DOMContentLoaded', function() {
    loadSidebar();
});

/* Sidebar Toggle */
function toggleSidebar(){
    document.getElementById("sidebar").classList.toggle("active");
    document.getElementById("overlay").classList.toggle("active");
}

/* Modal Functions */
function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

/* Close modal when clicking outside */
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.classList.remove('active');
    }
});

/* Action Menu Functions */
function toggleActionMenu(button, dealerId) {
    currentDealerId = dealerId;
    const dropdown = button.nextElementSibling;
    const allDropdowns = document.querySelectorAll('.action-dropdown');
    
    allDropdowns.forEach(d => {
        if (d !== dropdown) d.classList.remove('show');
    });
    
    dropdown.classList.toggle('show');
    
    document.addEventListener('click', function closeDropdown(e) {
        if (!button.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.remove('show');
            document.removeEventListener('click', closeDropdown);
        }
    });
}

/* Filter Dealers based on search input */
function filterDealers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    
    if (!searchTerm) {
        filteredDealersData = [...allDealersData];
    } else {
        filteredDealersData = allDealersData.filter(dealer => {
            return (
                (dealer.name && dealer.name.toLowerCase().includes(searchTerm)) ||
                (dealer.email && dealer.email.toLowerCase().includes(searchTerm)) ||
                (dealer.phone && dealer.phone.includes(searchTerm))
            );
        });
    }
    
    currentPage = 1; // Reset to first page when filtering
    renderDealersTable();
    updateStats(filteredDealersData);
    updatePagination();
}

/* ========== PAGINATION FUNCTIONS ========== */

function updatePagination() {
    totalDealers = filteredDealersData.length;
    const totalPages = Math.ceil(totalDealers / pageSize);
    
    // Calculate start and end indices for current page
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, totalDealers);
    
    // Update pagination info
    document.getElementById('paginationInfo').textContent = 
        `Showing ${startIndex + 1} to ${endIndex} of ${totalDealers} entries`;
    
    // Generate pagination buttons
    generatePaginationButtons(totalPages);
    
    // Show pagination if we have dealers
    document.getElementById('paginationContainer').style.display = 
        totalDealers > 0 ? 'flex' : 'none';
    
    return startIndex;
}

function generatePaginationButtons(totalPages) {
    const paginationButtons = document.getElementById('paginationButtons');
    let buttonsHTML = '';
    
    // Previous button
    buttonsHTML += `
        <button class="btn btn-sm btn-outline-secondary ${currentPage === 1 ? 'disabled' : ''}" 
                onclick="changePage(${currentPage - 1})" 
                ${currentPage === 1 ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i>
        </button>
    `;
    
    // Page number buttons
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    // Adjust start page if we're at the end
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    // First page and ellipsis
    if (startPage > 1) {
        buttonsHTML += `
            <button class="btn btn-sm btn-outline-secondary" onclick="changePage(1)">1</button>
            ${startPage > 2 ? '<span class="px-2">...</span>' : ''}
        `;
    }
    
    // Page number buttons
    for (let i = startPage; i <= endPage; i++) {
        buttonsHTML += `
            <button class="btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-outline-secondary'}" 
                    onclick="changePage(${i})">
                ${i}
            </button>
        `;
    }
    
    // Last page and ellipsis
    if (endPage < totalPages) {
        buttonsHTML += `
            ${endPage < totalPages - 1 ? '<span class="px-2">...</span>' : ''}
            <button class="btn btn-sm btn-outline-secondary" onclick="changePage(${totalPages})">
                ${totalPages}
            </button>
        `;
    }
    
    // Next button
    buttonsHTML += `
        <button class="btn btn-sm btn-outline-secondary ${currentPage === totalPages ? 'disabled' : ''}" 
                onclick="changePage(${currentPage + 1})" 
                ${currentPage === totalPages ? 'disabled' : ''}>
            <i class="fas fa-chevron-right"></i>
        </button>
    `;
    
    paginationButtons.innerHTML = buttonsHTML;
}

function changePage(page) {
    const totalPages = Math.ceil(totalDealers / pageSize);
    
    if (page < 1 || page > totalPages || page === currentPage) {
        return;
    }
    
    currentPage = page;
    renderDealersTable();
    
    // Scroll to top of table
    document.querySelector('.table-responsive').scrollTop = 0;
}

function changePageSize(newSize) {
    pageSize = parseInt(newSize);
    currentPage = 1; // Reset to first page when changing page size
    renderDealersTable();
}

/* Get current page data */
function getCurrentPageData() {
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    return filteredDealersData.slice(startIndex, endIndex);
}

/* Update last updated timestamp */
function updateLastUpdated() {
    const now = new Date();
    const formattedTime = now.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
    });
    document.getElementById('lastUpdated').textContent = `Last updated: ${formattedTime}`;
}

/* Load Dealers from API */
async function loadDealers() {
    const appId = localStorage.getItem('app_id');
    
    if (!appId) {
        showToast('Application ID not found. Please login again.', 'error');
        document.getElementById("tableBody").innerHTML = `
            <tr>
                <td colspan="6">
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h4>Authentication Required</h4>
                        <p>Please login to access dealer management</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    try {
        // Show loading state
        document.getElementById("tableBody").innerHTML = `
            <tr>
                <td colspan="6" style="text-align:center;padding:2rem;">
                    <span class="spinner"></span> Loading dealers...
                </td>
            </tr>
        `;

        // Hide pagination during loading
        document.getElementById('paginationContainer').style.display = 'none';

        // Show refresh button loading
        const refreshBtn = document.getElementById('refreshBtn');
        refreshBtn.innerHTML = '<span class="spinner"></span> Loading...';
        refreshBtn.disabled = true;

        console.log('Fetching dealers from API...');
        
        // Prepare the request body
        const requestData = {
            app_id: appId
        };
        
        console.log('Request data:', requestData);
        
        const response = await fetch(`${API_BASE_URL}/dealers.php`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const textData = await response.text();
        console.log('API Response (first 200 chars):', textData.substring(0, 200));
        
        let data;
        try {
            data = JSON.parse(textData);
            console.log('API Response parsed:', data);
        } catch (parseError) {
            console.error('Failed to parse JSON:', parseError);
            console.log('Full response:', textData);
            
            // Check if it's an HTML error page
            if (textData.includes('<!DOCTYPE') || textData.includes('<html') || textData.includes('Prepare')) {
                throw new Error('Server returned HTML instead of JSON. Check API endpoint and parameters.');
            }
            
            // Try to extract JSON from error message
            const jsonMatch = textData.match(/\{.*\}/s);
            if (jsonMatch) {
                try {
                    data = JSON.parse(jsonMatch[0]);
                } catch (e) {
                    throw new Error('Invalid JSON response from server');
                }
            } else {
                throw new Error('Invalid response format from server');
            }
        }
        
        if (data.result === "1" || data.success) {
            // Store the dealer data
            allDealersData = data.dealerdet || data.dealers || [];
            filteredDealersData = [...allDealersData];
            
            console.log('Dealers loaded:', allDealersData.length);
            
            // Reset to first page
            currentPage = 1;
            
            // Update stats
            updateStats(allDealersData);
            
            // Render the table
            renderDealersTable();
            
            // Update pagination
            updatePagination();
            
            // Update last updated time
            updateLastUpdated();
        } else {
            showToast(data.message || 'Failed to load dealers', 'error');
            console.error('API Error:', data);
        }
    } catch (error) {
        console.error('Error loading dealers:', error);
        showToast('Error loading dealers. Please check your connection.', 'error');
        
        // Show error state
        document.getElementById("tableBody").innerHTML = `
            <tr>
                <td colspan="6">
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h4>Connection Error</h4>
                        <p>Failed to load dealers. Please try again.</p>
                    </div>
                </td>
            </tr>
        `;
    } finally {
        // Reset refresh button
        const refreshBtn = document.getElementById('refreshBtn');
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
        refreshBtn.disabled = false;
    }
}

/* Update Stats */
function updateStats(dealers) {
    const total = dealers.length;
    const active = dealers.filter(d => d.status === 'Active' || d.status === 'active').length;
    const blocked = dealers.filter(d => d.status === 'Blocked' || d.status === 'blocked').length;
    
    document.getElementById("totalDealers").innerText = total;
    document.getElementById("activeDealers").innerText = active;
    document.getElementById("blockedDealers").innerText = blocked;
}

/* Render Dealers Table */
function renderDealersTable() {
    const tableBody = document.getElementById("tableBody");
    const currentPageData = getCurrentPageData();
    
    if (filteredDealersData.length === 0) {
        const searchTerm = document.getElementById('searchInput').value;
        if (searchTerm) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6">
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <h4>No dealers found</h4>
                            <p>No dealers match your search "${searchTerm}"</p>
                        </div>
                    </td>
                </tr>
            `;
        } else {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6">
                        <div class="empty-state">
                            <i class="fas fa-users-slash"></i>
                            <h4>No dealers found</h4>
                            <p>Add your first dealer to get started</p>
                        </div>
                    </td>
                </tr>
            `;
        }
        return;
    }
    
    const startSerial = (currentPage - 1) * pageSize + 1;
    
    tableBody.innerHTML = currentPageData.map((dealer, index) => {
        // Calculate actual index based on pagination
        const actualIndex = startSerial + index;
        
        // Determine status badge class
        let statusClass = 'primary';
        if (dealer.status === 'Active' || dealer.status === 'active') {
            statusClass = 'success';
        } else if (dealer.status === 'Blocked' || dealer.status === 'blocked') {
            statusClass = 'danger';
        }
        
        // Determine if dealer is active for block/unblock button
        const isActive = (dealer.status === 'Active' || dealer.status === 'active');
        
        return `
        <tr>
            <td class="serial-no">${actualIndex}</td>
            <td>${dealer.name || 'N/A'}</td>
            <td>${dealer.email || 'N/A'}</td>
            <td>${dealer.phone || 'N/A'}</td>
            <td>
                <span class="badge badge-${statusClass}">
                    ${dealer.status || 'Unknown'}
                </span>
            </td>
            <td>
                <div class="action-menu">
                    <button class="action-btn" onclick="toggleActionMenu(this, '${dealer.id}')">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div class="action-dropdown">
                        <button class="action-item view" onclick="viewDealer('${dealer.id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="action-item edit" onclick="editDealer('${dealer.id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="action-item delete" onclick="showDeleteConfirmation('${dealer.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        ${isActive ? 
                            `<button class="action-item block" onclick="showBlockConfirmation('${dealer.id}', true)">
                                <i class="fas fa-ban"></i> Block
                            </button>` :
                            `<button class="action-item unblock" onclick="showBlockConfirmation('${dealer.id}', false)">
                                <i class="fas fa-check-circle"></i> Unblock
                            </button>`
                        }
                    </div>
                </div>
            </td>
        </tr>
        `;
    }).join("");
}

/* View Dealer */
function viewDealer(dealerId) {
    const dealer = allDealersData.find(d => d.id === dealerId);
    
    if (dealer) {
        document.getElementById('dealerDetails').innerHTML = `
            <div style="display:grid;gap:1.5rem;">
                <div style="display:flex;align-items:center;gap:1rem;padding-bottom:1rem;border-bottom:1px solid var(--border-color);">
                    <div style="width:60px;height:60px;background:var(--light);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:var(--primary);">
                        ${dealer.name ? dealer.name.charAt(0).toUpperCase() : '?'}
                    </div>
                    <div>
                        <h4 style="margin:0 0 .25rem;color:var(--dark);">${dealer.name || 'N/A'}</h4>
                    </div>
                </div>
                <div style="display:grid;gap:1.25rem;">
                    <div>
                        <p style="margin:0 0 .25rem;color:var(--secondary);font-size:.875rem;">Name</p>
                        <p style="margin:0;color:var(--dark);font-weight:500;padding:.5rem .75rem;background:#f7f7fb;border-radius:.375rem;">${dealer.name || 'N/A'}</p>
                    </div>
                    <div>
                        <p style="margin:0 0 .25rem;color:var(--secondary);font-size:.875rem;">Address</p>
                        <p style="margin:0;color:var(--dark);padding:.5rem .75rem;background:#f7f7fb;border-radius:.375rem;">
                            ${dealer.address || 'No address provided'}
                        </p>
                    </div>
                    <div>
                        <p style="margin:0 0 .25rem;color:var(--secondary);font-size:.875rem;">Email</p>
                        <p style="margin:0;color:var(--dark);font-weight:500;padding:.5rem .75rem;background:#f7f7fb;border-radius:.375rem;">${dealer.email || 'N/A'}</p>
                    </div>
                    <div>
                        <p style="margin:0 0 .25rem;color:var(--secondary);font-size:.875rem;">Phone Number</p>
                        <p style="margin:0;color:var(--dark);font-weight:500;padding:.5rem .75rem;background:#f7f7fb;border-radius:.375rem;">${dealer.phone || 'N/A'}</p>
                    </div>
                    <div>
                        <p style="margin:0 0 .25rem;color:var(--secondary);font-size:.875rem;">Date</p>
                        <p style="margin:0;color:var(--dark);font-weight:500;padding:.5rem .75rem;background:#f7f7fb;border-radius:.375rem;">${dealer.date || dealer.joinDate || 'Not available'}</p>
                    </div>
                </div>
            </div>
        `;
        openModal('viewDealerModal');
    } else {
        showToast('Dealer not found', 'error');
    }
}

/* Edit Dealer */
function editDealer(dealerId) {
    const dealer = allDealersData.find(d => d.id === dealerId);
    
    if (dealer) {
        document.getElementById('editName').value = dealer.name || '';
        document.getElementById('editEmail').value = dealer.email || '';
        document.getElementById('editPhone').value = dealer.phone || '';
        document.getElementById('editAddress').value = dealer.address || '';
        document.getElementById('editPassword').value = '';
        
        currentDealerId = dealerId;
        openModal('editDealerModal');
    } else {
        showToast('Dealer not found', 'error');
    }
}

/* Show Delete Confirmation */
function showDeleteConfirmation(dealerId) {
    const dealer = allDealersData.find(d => d.id === dealerId);
    
    if (dealer) {
        dealerToDelete = dealerId;
        const dealerName = dealer.name || 'this dealer';
        document.getElementById('deleteConfirmationText').innerHTML = `
            Are you sure you want to delete dealer <strong>"${dealerName}"</strong>?<br><br>
            <small style="color: var(--danger);">
                <i class="fas fa-exclamation-circle"></i> This action cannot be undone.
            </small>
        `;
        openModal('deleteConfirmationModal');
    } else {
        showToast('Dealer not found', 'error');
    }
}

/* Show Block/Unblock Confirmation */
function showBlockConfirmation(dealerId, blockAction) {
    const dealer = allDealersData.find(d => d.id === dealerId);
    
    if (dealer) {
        dealerToToggleStatus = dealerId;
        isBlockAction = blockAction;
        const dealerName = dealer.name || 'this dealer';
        const actionText = blockAction ? 'block' : 'unblock';
        const actionColor = blockAction ? 'warning' : 'success';
        const actionIcon = blockAction ? 'fa-ban' : 'fa-check-circle';
        
        // Update modal title and content
        document.getElementById('blockModalTitle').innerHTML = `<i class="fas fa-exclamation-triangle"></i> Confirm ${blockAction ? 'Block' : 'Unblock'}`;
        document.getElementById('blockConfirmationIcon').innerHTML = `<i class="fas ${actionIcon}"></i>`;
        document.getElementById('blockConfirmationIcon').className = `block-confirmation-icon ${blockAction ? 'block' : 'unblock'}`;
        document.getElementById('blockConfirmationText').innerHTML = `
            Are you sure you want to ${actionText} dealer <strong>"${dealerName}"</strong>?<br><br>
            <small style="color: var(--${actionColor});">
                <i class="fas fa-exclamation-circle"></i> This will ${blockAction ? 'prevent' : 'allow'} the dealer from accessing the system.
            </small>
        `;
        
        // Update confirm button
        const confirmBtn = document.getElementById('confirmBlockBtn');
        confirmBtn.className = blockAction ? 'btn btn-confirm-block' : 'btn btn-confirm-unblock';
        confirmBtn.innerHTML = `<i class="fas ${actionIcon}"></i> ${blockAction ? 'Block' : 'Unblock'}`;
        
        openModal('blockConfirmationModal');
    } else {
        showToast('Dealer not found', 'error');
    }
}

/* Confirm Delete - Call API */
async function confirmDelete() {
    if (!dealerToDelete) {
        showToast('No dealer selected for deletion', 'error');
        return;
    }
    
    const appId = localStorage.getItem('app_id');
    
    if (!appId) {
        showToast('Application ID not found. Please login again.', 'error');
        closeModal('deleteConfirmationModal');
        return;
    }
    
    const dealer = allDealersData.find(d => d.id === dealerToDelete);
    const dealerName = dealer ? dealer.name : dealerToDelete;
    
    try {
        // Prepare delete data EXACTLY as required
        const deleteData = {
            app_id: appId,
            action: "DeleteDealer",
            dlrid: dealerToDelete
        };
        
        console.log('Deleting dealer with data:', deleteData);
        
        // Show loading state on button
        const deleteBtn = document.getElementById('confirmDeleteBtn');
        const originalText = deleteBtn.innerHTML;
        deleteBtn.innerHTML = '<span class="spinner"></span> Deleting...';
        deleteBtn.disabled = true;
        
        // Call the delete API endpoint
        const response = await fetch(`${API_BASE_URL}/action/dealer.php`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(deleteData)
        });
        
        // First, get the response as text
        const textData = await response.text();
        console.log('Delete dealer response (first 200 chars):', textData.substring(0, 200));
        console.log('Full response length:', textData.length);
        
        let data;
        
        // Try to parse as JSON first
        try {
            data = JSON.parse(textData);
            console.log('Delete response parsed as JSON:', data);
        } catch (parseError) {
            console.error('Failed to parse response as JSON:', parseError);
            
            // If not JSON, check for HTML error
            if (textData.includes('<!DOCTYPE') || textData.includes('<html') || textData.includes('Prepare')) {
                console.error('Server returned HTML error page');
                
                // Try to extract error message from HTML
                let errorMessage = 'Server error occurred during deletion';
                
                if (textData.includes('Prepare')) {
                    // Extract error details from PHP error
                    const errorMatch = textData.match(/Prepare[^<]+/);
                    if (errorMatch) {
                        errorMessage = errorMatch[0].substring(0, 100);
                    }
                }
                
                throw new Error(errorMessage);
            }
            
            // Check if response contains success indicators (even if not JSON)
            if (textData.toLowerCase().includes('success') || 
                textData.toLowerCase().includes('deleted') || 
                textData.toLowerCase().includes('removed')) {
                data = { success: true, message: 'Dealer deleted successfully' };
            } else {
                // Try to extract any JSON-like structure
                const jsonMatch = textData.match(/\{.*\}/s);
                if (jsonMatch) {
                    try {
                        data = JSON.parse(jsonMatch[0]);
                    } catch (e) {
                        throw new Error('Invalid response format: ' + textData.substring(0, 100));
                    }
                } else {
                    throw new Error('Unexpected response from server: ' + textData.substring(0, 100));
                }
            }
        }
        
        if (data.result === "1" || data.success) {
            showToast(`Dealer "${dealerName}" deleted successfully!`, 'success');
            closeModal('deleteConfirmationModal');
            loadDealers(); // Refresh the list
        } else {
            showToast(data.message || 'Failed to delete dealer', 'error');
        }
    } catch (error) {
        console.error('Error deleting dealer:', error);
        showToast('Error: ' + error.message, 'error');
    } finally {
        // Reset button state
        const deleteBtn = document.getElementById('confirmDeleteBtn');
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
        deleteBtn.disabled = false;
        dealerToDelete = null;
    }
}

/* Confirm Block/Unblock - Using StatusUpdate API */
async function confirmBlockUnblock() {
    if (!dealerToToggleStatus) {
        showToast('No dealer selected', 'error');
        return;
    }
    
    const appId = localStorage.getItem('app_id');
    
    if (!appId) {
        showToast('Application ID not found. Please login again.', 'error');
        closeModal('blockConfirmationModal');
        return;
    }
    
    const dealer = allDealersData.find(d => d.id === dealerToToggleStatus);
    const dealerName = dealer ? dealer.name : dealerToToggleStatus;
    const actionText = isBlockAction ? 'block' : 'unblock';
    const newStatus = isBlockAction ? 'Blocked' : 'Active';
    
    try {
        // Prepare data for status update - EXACTLY as required
        const statusData = {
            app_id: appId,
            action: "StatusUpdate",  // Changed from "edit" to "StatusUpdate"
            dlrid: dealerToToggleStatus
        };
        
        console.log(`${isBlockAction ? 'Blocking' : 'Unblocking'} dealer with data:`, statusData);
        
        // Show loading state on button
        const actionBtn = document.getElementById('confirmBlockBtn');
        actionBtn.innerHTML = '<span class="spinner"></span> Processing...';
        actionBtn.disabled = true;
        
        // Call the API endpoint to update status
        const response = await fetch(`${API_BASE_URL}/action/dealer.php`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(statusData)
        });
        
        // First, get the response as text
        const textData = await response.text();
        console.log('Status update response (first 200 chars):', textData.substring(0, 200));
        
        let data;
        
        // Try to parse as JSON first
        try {
            data = JSON.parse(textData);
            console.log('Status update response parsed as JSON:', data);
        } catch (parseError) {
            console.error('Failed to parse response as JSON:', parseError);
            
            // If not JSON, check for HTML error
            if (textData.includes('<!DOCTYPE') || textData.includes('<html') || textData.includes('Prepare')) {
                console.error('Server returned HTML error page');
                throw new Error('Server error occurred');
            }
            
            // Check if response contains success indicators
            if (textData.toLowerCase().includes('success') || 
                textData.toLowerCase().includes('updated')) {
                data = { success: true, message: `Dealer ${actionText}ed successfully` };
            } else {
                throw new Error('Invalid response from server');
            }
        }
        
        // Check response based on your API structure
        if (data.result === "1" || data.success || data.status === "success") {
            showToast(`Dealer "${dealerName}" ${actionText}ed successfully!`, 'success');
            closeModal('blockConfirmationModal');
            
            // Update the local data immediately without reloading
            const dealerIndex = allDealersData.findIndex(d => d.id === dealerToToggleStatus);
            if (dealerIndex !== -1) {
                allDealersData[dealerIndex].status = newStatus;
                filteredDealersData = [...allDealersData];
                renderDealersTable();
                updateStats(allDealersData);
                updatePagination(); // Update pagination after status change
            }
        } else {
            showToast(data.message || data.error || `Failed to ${actionText} dealer`, 'error');
        }
    } catch (error) {
        console.error(`Error ${actionText}ing dealer:`, error);
        showToast('Error: ' + error.message, 'error');
    } finally {
        // Reset button state
        const actionBtn = document.getElementById('confirmBlockBtn');
        actionBtn.innerHTML = isBlockAction ? '<i class="fas fa-ban"></i> Block' : '<i class="fas fa-check-circle"></i> Unblock';
        actionBtn.disabled = false;
        dealerToToggleStatus = null;
    }
}

/* Update Dealer */
async function updateDealer() {
    const appId = localStorage.getItem('app_id');
    
    if (!appId) {
        showToast('Application ID not found. Please login again.', 'error');
        return;
    }
    
    const form = document.getElementById('editDealerForm');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    try {
        // Get password value
        const password = document.getElementById('editPassword').value.trim();
        
        // Prepare update data exactly as required
        const updateData = {
            app_id: appId,
            action: "edit",
            dlrid: currentDealerId,
            name: document.getElementById('editName').value.trim(),
            email: document.getElementById('editEmail').value.trim(),
            phone: document.getElementById('editPhone').value.trim(),
            address: document.getElementById('editAddress').value.trim(),
            password: password === "" ? "No Password To Update" : password,
        };
        
        console.log('Updating dealer with data:', updateData);
        
        // Show loading state on button
        const updateBtn = document.getElementById('updateDealerBtn');
        const originalText = updateBtn.innerHTML;
        updateBtn.innerHTML = '<span class="spinner"></span> Updating...';
        updateBtn.disabled = true;
        
        // Call the edit API endpoint
        const response = await fetch(`${API_BASE_URL}/action/dealer.php`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updateData)
        });
        
        const textData = await response.text();
        console.log('Update response (first 200 chars):', textData.substring(0, 200));
        
        let data;
        try {
            data = JSON.parse(textData);
            console.log('Update response parsed:', data);
        } catch (parseError) {
            console.error('Failed to parse update response:', parseError);
            
            // Check if response contains success indicators
            if (textData.toLowerCase().includes('success') || textData.toLowerCase().includes('updated')) {
                data = { success: true, message: 'Dealer updated successfully' };
            } else {
                throw new Error('Invalid response from server: ' + textData.substring(0, 100));
            }
        }
        
        if (data.result === "1" || data.success) {
            showToast('Dealer updated successfully!', 'success');
            closeModal('editDealerModal');
            loadDealers(); // Refresh the list
        } else {
            showToast(data.message || 'Failed to update dealer', 'error');
        }
    } catch (error) {
        console.error('Error updating dealer:', error);
        showToast('Error updating dealer. Please try again.', 'error');
    } finally {
        // Reset button state
        const updateBtn = document.getElementById('updateDealerBtn');
        updateBtn.innerHTML = '<i class="fas fa-save"></i> Update Dealer';
        updateBtn.disabled = false;
    }
}

/* Save New Dealer - Using INSERT API */
async function saveDealer() {
    const appId = localStorage.getItem('app_id');
    
    if (!appId) {
        showToast('Application ID not found. Please login again.', 'error');
        return;
    }
    
    const form = document.getElementById('addDealerForm');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    try {
        // Get form values
        const name = document.getElementById('addName').value.trim();
        const email = document.getElementById('addEmail').value.trim();
        const phone = document.getElementById('addPhone').value.trim();
        const password = document.getElementById('addPassword').value.trim();
        const address = document.getElementById('addAddress').value.trim();
        
        // Validate password length
        if (password.length < 6) {
            showToast('Password must be at least 6 characters long', 'error');
            return;
        }
        
        // Prepare new dealer data EXACTLY as required
        const newDealerData = {
            app_id: appId,
            action: "insert",
            name: name,
            email: email,
            phone: phone,
            address: address,
            password: password
        };
        
        console.log('Adding new dealer with data:', newDealerData);
        
        // Show loading state on button
        const saveBtn = document.getElementById('saveDealerBtn');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<span class="spinner"></span> Saving...';
        saveBtn.disabled = true;
        
        // Call the insert API endpoint
        const response = await fetch(`${API_BASE_URL}/action/dealer.php`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(newDealerData)
        });
        
        // First, get the response as text
        const textData = await response.text();
        console.log('Add dealer response (first 200 chars):', textData.substring(0, 200));
        console.log('Full response length:', textData.length);
        
        let data;
        
        // Try to parse as JSON first
        try {
            data = JSON.parse(textData);
            console.log('Add dealer response parsed as JSON:', data);
        } catch (parseError) {
            console.error('Failed to parse response as JSON:', parseError);
            
            // If not JSON, check for HTML error
            if (textData.includes('<!DOCTYPE') || textData.includes('<html') || textData.includes('Prepare')) {
                console.error('Server returned HTML error page');
                
                // Try to extract error message from HTML
                let errorMessage = 'Server error occurred';
                
                if (textData.includes('Prepare')) {
                    // Extract error details from PHP error
                    const errorMatch = textData.match(/Prepare[^<]+/);
                    if (errorMatch) {
                        errorMessage = errorMatch[0].substring(0, 100);
                    }
                }
                
                throw new Error(errorMessage);
            }
            
            // Check if response contains success indicators (even if not JSON)
            if (textData.toLowerCase().includes('success') || 
                textData.toLowerCase().includes('inserted') || 
                textData.toLowerCase().includes('added')) {
                data = { success: true, message: 'Dealer added successfully' };
            } else {
                // Try to extract any JSON-like structure
                const jsonMatch = textData.match(/\{.*\}/s);
                if (jsonMatch) {
                    try {
                        data = JSON.parse(jsonMatch[0]);
                    } catch (e) {
                        throw new Error('Invalid response format: ' + textData.substring(0, 100));
                    }
                } else {
                    throw new Error('Unexpected response from server: ' + textData.substring(0, 100));
                }
            }
        }
        
        if (data.result === "1" || data.success) {
            showToast('New dealer added successfully!', 'success');
            closeModal('addDealerModal');
            form.reset();
            loadDealers(); // Refresh the list
        } else {
            showToast(data.message || 'Failed to add dealer', 'error');
        }
    } catch (error) {
        console.error('Error adding dealer:', error);
        showToast('Error: ' + error.message, 'error');
    } finally {
        // Reset button state
        const saveBtn = document.getElementById('saveDealerBtn');
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Dealer';
        saveBtn.disabled = false;
    }
}

/* Initialize */
document.addEventListener("DOMContentLoaded", () => {
    console.log('Dealer Management System Initialized');
    console.log('API Base URL:', API_BASE_URL);
    
    // Check if app_id exists in localStorage
    const appId = localStorage.getItem('app_id');
    console.log('Loaded app_id from localStorage:', appId ? 'Yes' : 'No');
    
    if (appId) {
        // Load dealers from API
        loadDealers();
    } else {
        showToast('Please login to access dealer management', 'error');
        document.getElementById("tableBody").innerHTML = `
            <tr>
                <td colspan="6">
                    <div class="empty-state">
                        <i class="fas fa-key"></i>
                        <h4>Authentication Required</h4>
                        <p>Please login to access dealer management</p>
                    </div>
                </td>
            </tr>
        `;
    }
    
    // Add dealer button event
    document.getElementById("addDealerBtn").addEventListener("click", function() {
        const appId = localStorage.getItem('app_id');
        if (!appId) {
            showToast('Application ID not found. Please login first.', 'error');
            return;
        }
        openModal('addDealerModal');
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.action-menu')) {
            document.querySelectorAll('.action-dropdown').forEach(d => {
                d.classList.remove('show');
            });
        }
    });
    
    // Page size selector event
    document.getElementById("pageSizeSelect").addEventListener("change", function(e) {
        changePageSize(e.target.value);
    });
    
    // Refresh button spin animation
    document.getElementById("refreshBtn").addEventListener("click", function() {
        const icon = this.querySelector('i');
        icon.classList.add('fa-spin');
        
        loadDealers().finally(() => {
            setTimeout(() => {
                icon.classList.remove('fa-spin');
            }, 500);
        });
    });
});
</script>

</body>
</html>